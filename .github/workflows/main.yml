name: CI Pipeline

on:
  push:
    branches: [ "main", "develop", "helm" ]
  pull_request:

env:
  MAVEN_OPTS: "-Dhttps.protocols=TLSv1.2 -Dmaven.repo.local=${{ github.workspace }}/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=jarN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true"
  MAVEN_CLI_OPTS: "clean -Dskip.karma=true -Dmaven.test.failure.ignore=true -DskipTests -Dmaven.deploy.skip=true --batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true -s m2settings.xml"

  KUBERNETES_CPU_REQUEST: "2"
  KUBERNETES_CPU_LIMIT: "3"
  KUBERNETES_MEMORY_REQUEST: "2Gi"
  KUBERNETES_MEMORY_LIMIT: "3Gi"
  KUBERNETES_HELPER_MEMORY_REQUEST: "2Gi"
  KUBERNETES_HELPER_MEMORY_LIMIT: "3Gi"
  KUBERNETES_HELPER_CPU_REQUEST: "2"
  KUBERNETES_HELPER_CPU_LIMIT: "3"

# ======================================================================
# INIT STAGE — GENERATE TAG LIST (GitLab include equivalent)
# ======================================================================
jobs:
  tag_list:
    runs-on: ubuntu-latest

    outputs:
      TAG_LIST: ${{ steps.tags.outputs.TAG_LIST }}

    steps:
      - uses: actions/checkout@v4

      - name: Generate TAG_LIST
        id: tags
        run: |
          TAG=$(git rev-parse --short HEAD)
          echo "TAG_LIST=$TAG" >> $GITHUB_OUTPUT
          echo "TAG_LIST: $TAG"

# ======================================================================
# BUILD STAGE — MAVEN PACKAGE
# ======================================================================
  build-jar:
    runs-on: ubuntu-latest
    needs: tag_list

    container:
      image: maven:3-eclipse-temurin-21

    steps:
      - uses: actions/checkout@v4

      - name: Cache Maven Repo
        uses: actions/cache@v3
        with:
          path: |
            .m2/repository
            backend/target
            backend/frontend/node_modules
            backend/node
          key: maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-

      - name: Build JAR
        run: mvn package -DskipTests=true

      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: target/*.jar

# ======================================================================
# BUILD STAGE — KANIKO IMAGE BUILD
# ======================================================================
  container_web:
    runs-on: ubuntu-latest
    needs: [ tag_list, build-jar ]

    container:
      image: gcr.io/kaniko-project/executor:debug

    env:
      CAMDEN_REGISTRY: ${{ secrets.CAMDEN_REGISTRY }}
      CAMDEN_REGISTRY_USER: ${{ secrets.CAMDEN_REGISTRY_USER }}
      CAMDEN_REGISTRY_PASSWORD: ${{ secrets.CAMDEN_REGISTRY_PASSWORD }}
      TAG_LIST: ${{ needs.tag_list.outputs.TAG_LIST }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure Kaniko Docker auth
        run: |
          echo "{\"auths\":{
            \"${CAMDEN_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CAMDEN_REGISTRY_USER}" "${CAMDEN_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}
          }}" > /kaniko/.docker/config.json

      - name: Kaniko Build & Push
        run: |
          echo "Using TAG_LIST=$TAG_LIST"

          destargs=""
          for tag in $TAG_LIST; do
            destargs="$destargs --destination=${CAMDEN_REGISTRY}/gbi/web:${tag}"
          done

          /kaniko/executor \
            --context="${GITHUB_WORKSPACE}/" \
            --dockerfile="${GITHUB_WORKSPACE}/Dockerfile" \
            $destargs

# ======================================================================
# DEPLOY STAGE — ARGOCD
# ======================================================================
  argo-test-web:
    runs-on: ubuntu-latest
    needs: container_web

    container:
      image: argoproj/argocd:latest

    env:
      ARGOCD_AUTH_TOKEN: ${{ secrets.ARGO_TOKEN }}
      ARGO_APP: gbi

    steps:
      - name: Deploy to ArgoCD
        run: |
          argocd --server argocd.anaeleboo.com --insecure --grpc-web \
            app set "$ARGO_APP" \
            -p web.image.tag="${GITHUB_SHA::7}"
