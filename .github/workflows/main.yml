name: CI/CD with Kaniko

on:
  push:
    branches:
      - main
      - master
      - develop

env:
  MAVEN_OPTS: -Dhttps.protocols=TLSv1.2 -Dmaven.repo.local=/home/runner/work/eagle1-project/eagle1-project/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=jarN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true
  MAVEN_CLI_OPTS: clean -Dskip.karma=true -Dmaven.test.failure.ignore=true -DskipTests -Dmaven.deploy.skip=true --batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true 
  KUBERNETES_CPU_REQUEST: 2
  KUBERNETES_CPU_LIMIT: 3
  KUBERNETES_MEMORY_REQUEST: 2Gi
  KUBERNETES_MEMORY_LIMIT: 3Gi
  KUBERNETES_HELPER_MEMORY_REQUEST: 2Gi
  KUBERNETES_HELPER_MEMORY_LIMIT: 3Gi
  KUBERNETES_HELPER_CPU_REQUEST: 2
  KUBERNETES_HELPER_CPU_LIMIT: 3

  CAMDEN_REGISTRY: ${{ secrets.CAMDEN_REGISTRY }}
  CAMDEN_REGISTRY_USER: ${{ secrets.CAMDEN_REGISTRY_USER }}
  CAMDEN_REGISTRY_PASSWORD: ${{ secrets.CAMDEN_REGISTRY_PASSWORD }}

jobs:

  build:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set_tag.outputs.TAG_LIST }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Build with Maven
        run: mvn $MAVEN_CLI_OPTS

      - name: Set TAG_LIST
        id: set_tag
        run: |
          echo "TAG_LIST=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "TAG_LIST=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

  kaniko:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set TAG_LIST from previous job
        run: echo "TAG_LIST=${{ needs.build.outputs.tag }}" >> $GITHUB_ENV

      - name: Prepare Docker auth for Kaniko
        run: |
          mkdir -p ~/.docker
          echo "{\"auths\": {\"docker.io\": {\"auth\": \"$(echo -n ${CAMDEN_REGISTRY_USER}:${CAMDEN_REGISTRY_PASSWORD} | base64)\"}}}" > ~/.docker/config.json

      - name: Build & Push Docker image using Kaniko
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.docker:/kaniko/.docker \
            gcr.io/kaniko-project/executor:debug \
            --context=/workspace \
            --dockerfile=/workspace/Dockerfile \
            --destination=docker.io/${CAMDEN_REGISTRY_USER}/web:${TAG_LIST}

  deploy:
    runs-on: ubuntu-latest
    needs: kaniko
    steps:
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: Deploy to ArgoCD
        env:
          ARGOCD_AUTH_TOKEN: ${{ secrets.ARGO_TOKEN }}
          ARGO_APP: gbi
          TAG_LIST: ${{ needs.build.outputs.tag }}
        run: |
          argocd --server argocd.anaeleboo.com --insecure --grpc-web \
            login argocd.anaeleboo.com --token $ARGOCD_AUTH_TOKEN
          argocd app set "$ARGO_APP" -p web.image.tag="$TAG_LIST"
          argocd app sync "$ARGO_APP"
